<html>
	<head>
		<meta charset="UTF-8">
		<title>Development testing</title>
		<script src="https://code.jquery.com/jquery-2.2.0.js"></script>
		<style>
			pre {
				background-color: silver;
				padding: 16px;
			}
			
			#text-error {
				display: none;
				color: red;
			}
			
			#text-pending {
				display: none;
				color: silver;
			}
			
			.tablist button.current {
				font-weight: bold;
				color: blue;
			}
			
			.authentication-status {
				margin: 16px 0px;
				font-weight: bold;
				font-size: 18px;
			}
			
			.authentication-status .status {
				display: none;
			}
			
			.authentication-status .pending {
				display: inline;
			}
			
			.authentication-status .authenticated {
				color: green;
			}
			
			.authentication-status .unauthenticated {
				color: red;
			}
			
			.modify-user-form, .delete-user-form {
				display: none;
			}
			
			.template {
				display: none;
			}
		</style>
		<script>
			function hideStatus() {
				$("#text-pending").hide();
				$("#text-error").hide();
				$(".authentication-status .status").hide();
			}

			function setAuthStatus(authenticated) {
				if (authenticated === "true") {
					$(".authentication-status .status.authenticated").show();
				} else {
					$(".authentication-status .status.unauthenticated").show();
				}
			}

			function switchTab(tab) {
				$("section").hide();
				$("section.tab-" + tab).show();

				$(".tablist button").removeClass("current");
				$(".tablist button[data-tab='" + tab + "']").addClass("current");
			}
			
			function makeRequest(options, success, error) {
				var data = (options.data != null) ? JSON.stringify(options.data) : undefined;
				delete options.data;
				
				var combinedOptions = Object.assign({
					data: data,
					dataType: "json",
					headers: {
						"Content-Type": "application/json"
					},
					success: function(data, _, status) {
						hideStatus();
						success(data);
					},
					error: function(status) {
						hideStatus();
						$("#text-error").show();
						error(status.responseJSON);
					},
					complete: function(jqXHR) {
						setAuthStatus(jqXHR.getResponseHeader("X-API-Authenticated"));
					}
				}, options);
				
				$.ajax(combinedOptions);
			}
			
			function createLookup(type, apiPath) {
				function setupForm(item) {
					var form = $(".modify-form[data-type='" + type + "']");
					var template = form.find(".template[data-template='modify-field']");

					form.show().attr("action", apiPath + "/" + item.id);

					form.find("div:not(.template)").remove();

					Object.keys(item).forEach(function(key) {
						var element = template
							.clone()
							.removeClass("template")
							.appendTo(template.parent());

						element.children(".key").text(key);
						element.children("input").attr("name", key).val(item[key]);
					})

					$(".delete-form[data-type='" + type + "']").show().attr("action", apiPath + "/" + item.id);
				}
				
				return function(formData) {
					makeRequest({
						method: "get",
						url: apiPath + "/" + formData.id
					}, function(data) {
						console.log(data);
						setupForm(data);
					}, function(data) {
						$("#response").text(JSON.stringify(data, null, 4));
					});
				}
			}

			var lookupUser = createLookup("user", "/admin/users");
			var lookupPlan = createLookup("plan", "/admin/plans");
			var lookupPreset = createLookup("preset", "/admin/presets");
			var lookupSite = createLookup("site", "/admin/sites");
			
			$(function() {
				$("section").hide();
				$(".tablist button").on("click", function(event) {
					switchTab($(this).data("tab"));
				})
				
				$("form").each(function() {
					var form = $(this);
					
					form.on("submit", function(event) {
						event.preventDefault();
						
						hideStatus();
						$("#response").text("...");
						$("#text-pending").show();
						
						var data = {};
						var dataArray = form.serializeArray();
						
						dataArray.forEach(function(item) {
							/* For simplicity, pretend that arrays and nested objects don't exist. */
							if (item.value !== "") {
								if (item.value === "true") {
									data[item.name] = true;
								} else if (item.value === "false") {
									data[item.name] = false;
								} else if (/^[0-9]+$/.test(item.value)) {
									data[item.name] = parseInt(item.value);
								} else {
									data[item.name] = item.value;
								}
							}
						})
						
						if (form.data("handler") != null) {
							var handler = window[form.data("handler")];
							handler(data);
						} else {
							makeRequest({
								method: form.attr("method"),
								url: form.attr("action"),
								data: data
							}, function(data) {
								$("#response").text(JSON.stringify(data, null, 4));
							}, function(data) {
								$("#response").text(JSON.stringify(data, null, 4));
							});
						}
					})
				});
			})
		</script>
	</head>
	<body>
		<h1>
			Response
			<span id="text-pending">pending...</span>
			<span id="text-error">ERROR</span>
		</h1>
		<pre id="response"></pre>
		
		<div class="authentication-status">
			<strong>Authentication status:</strong>
			<span class="status pending">...</span>
			<span class="status unauthenticated">Unauthenticated</span>
			<span class="status authenticated">Authenticated</span>
		</div>
		
		<div class="tablist">
			<div>
				Auth:
				<button data-tab="register">Register</button>
				<button data-tab="login">Login</button>
				<button data-tab="change-password">Change password</button>
				<button data-tab="token">Generate Firebase token</button>
				<button data-tab="logout">Log out</button>
			</div>
			
			<div>
				Presets:
				<button data-tab="presets">List</button>
			</div>
			
			<div>
				Signed requests:
				<button data-tab="signed-request-preset">Change preset</button>
			</div>
			
			<hr>
			
			<div>
				Roles (admin-only):
				<button data-tab="admin-roles">List</button>
			</div>
			
			<div>
				Users (admin-only):
				<button data-tab="admin-list-users">List</button>
				<button data-tab="admin-create-user">Create</button>
				<button data-tab="admin-modify-users">Lookup / Modify</button>
			</div>
			
			<div>
				Plans (admin-only):
				<button data-tab="admin-list-plans">List</button>
				<button data-tab="admin-create-plan">Create</button>
				<button data-tab="admin-modify-plans">Lookup / Modify</button>
			</div>
			
			<div>
				Sites (admin-only):
				<button data-tab="admin-list-sites">List</button>
				<button data-tab="admin-create-site">Create</button>
				<button data-tab="admin-modify-sites">Lookup / Modify</button>
			</div>
			
			<div>
				Presets (admin-only):
				<button data-tab="admin-list-presets">List</button>
				<button data-tab="admin-create-preset">Create</button>
				<button data-tab="admin-modify-presets">Lookup / Modify</button>
			</div>
			
			<hr>
		</div>
		
		<section class="tab-register">
			<h1>Register</h1>
			<form action="/register" method="post">
				<div>
					E-mail address:
					<input type="text" name="email">
				</div>
				<div>
					Password:
					<input type="password" name="password">
				</div>
				<div>
					First name:
					<input type="text" name="firstName">
				</div>
				<div>
					Last name:
					<input type="text" name="lastName">
				</div>

				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-login">
			<h1>Login</h1>
			<form action="/login" method="post">
				<div>
					E-mail address:
					<input type="text" name="email">
				</div>
				<div>
					Password:
					<input type="password" name="password">
				</div>

				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-change-password">
			<h1>Change password</h1>
			<form action="/change-password" method="post">
				<div>
					Old password:
					<input type="text" name="oldPassword">
				</div>
				<div>
					New password:
					<input type="password" name="password">
				</div>

				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-token">
			<h1>Generate Firebase token</h1>
			<form action="/generate-token" method="post">
				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-logout">
			<h1>Log out</h1>
			<form action="/logout" method="post">
				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-presets">
			<h1>Presets</h1>
			<form action="/presets" method="get">
				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-signed-request-preset">
			<h1>Presets</h1>
			<form action="/generate-signed-request/preset" method="post">
				<div>
					Hostname:
					<input type="text" name="hostname">
				</div>
				<div>
					Preset ID:
					<input type="text" name="presetId">
				</div>
				
				<button type="submit">Send</button>
			</form>
		</section>
		
		
		<!-- ADMIN: Roles -->
		
		<section class="tab-admin-roles">
			<h1>List roles</h1>
			<form action="/admin/roles" method="get">
				<button type="submit">Send</button>
			</form>
		</section>
		
		
		<!-- ADMIN: Users -->
		
		<section class="tab-admin-list-users">
			<h1>List users</h1>
			<form action="/admin/users" method="get">
				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-admin-modify-users">
			<h1>Lookup / modify users</h1>
			<form data-handler="lookupUser">
				<div>
					ID:
					<input type="text" name="id">
				</div>
				
				<button type="submit">Lookup</button>
			</form>
			
			<h2>Deletion</h2>
			<form data-type="user" class="delete-form" action="about:blank" method="delete">
				<button type="submit">Delete</button>
			</form>
			
			<h2>Modification</h2>
			<form data-type="user" class="modify-form" action="about:blank" method="put">
				<div class="template" data-template="modify-field">
					<span class="key"></span>:
					<input class="value" type="text" name="">
				</div>
				
				<button type="submit">Save</button>
			</form>
		</section>
		
		<section class="tab-admin-create-user">
			<h1>Create user</h1>
			<form class="create-user-form" action="/admin/users" method="post">
				<div>
					<span class="key">E-mail address</span>:
					<input class="value" type="text" name="email">
				</div>
				<div>
					<span class="key">Password</span>:
					<input class="value" type="text" name="password">
				</div>
				<div>
					<span class="key">isActive</span>:
					<input class="value" type="text" name="isActive">
				</div>
				<div>
					<span class="key">Role</span>:
					<input class="value" type="text" name="role">
				</div>
				
				<hr>
				
				<div>
					<span class="key">First name</span>:
					<input class="value" type="text" name="firstName">
				</div>
				<div>
					<span class="key">Last name</span>:
					<input class="value" type="text" name="lastName">
				</div>
				<div>
					<span class="key">Address line 1</span>:
					<input class="value" type="text" name="address1">
				</div>
				<div>
					<span class="key">Address line 2</span>:
					<input class="value" type="text" name="address2">
				</div>
				<div>
					<span class="key">Postal code</span>:
					<input class="value" type="text" name="postalCode">
				</div>
				<div>
					<span class="key">City</span>:
					<input class="value" type="text" name="city">
				</div>
				<div>
					<span class="key">State</span>:
					<input class="value" type="text" name="state">
				</div>
				<div>
					<span class="key">Country</span>:
					<input class="value" type="text" name="country">
				</div>
				
				<button type="submit">Send</button>
			</form>
		</section>
		
		
		<!-- ADMIN: Sites -->
		
		<section class="tab-admin-list-sites">
			<h1>List sites</h1>
			<form action="/admin/sites" method="get">
				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-admin-modify-sites">
			<h1>Lookup / modify sites</h1>
			<form data-handler="lookupSite">
				<div>
					ID:
					<input type="text" name="id">
				</div>
				
				<button type="submit">Lookup</button>
			</form>
			
			<h2>Deletion</h2>
			<form data-type="site" class="delete-form" action="about:blank" method="delete">
				<button type="submit">Delete</button>
			</form>
			
			<h2>Modification</h2>
			<form data-type="site" class="modify-form" action="about:blank" method="put">
				<div class="template" data-template="modify-field">
					<span class="key"></span>:
					<input class="value" type="text" name="">
				</div>
				
				<button type="submit">Save</button>
			</form>
		</section>
		
		<section class="tab-admin-create-site">
			<h1>Create site</h1>
			<form class="create-site-form" action="/admin/sites" method="post">
				<div>
					<span class="key">Plan ID</span>:
					<input class="value" type="text" name="planId">
				</div>
				<div>
					<span class="key">User ID</span>:
					<input class="value" type="text" name="userId">
				</div>
				
				<hr>
				
				<div>
					<span class="key">Site name (title)</span>:
					<input class="value" type="text" name="siteName">
				</div>
				<div>
					<span class="key">Subdomain (without domain)</span>:
					<input class="value" type="text" name="subdomainName">
				</div>
				<div>
					<span class="key">Custom domain</span>:
					<input class="value" type="text" name="domainName">
				</div>
				
				<button type="submit">Send</button>
			</form>
		</section>
		
		
		<!-- ADMIN: Plans -->
		
		<section class="tab-admin-list-plans">
			<h1>List plans</h1>
			<form action="/admin/plans" method="get">
				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-admin-modify-plans">
			<h1>Lookup / modify plans</h1>
			<form data-handler="lookupPlan">
				<div>
					ID:
					<input type="text" name="id">
				</div>
				
				<button type="submit">Lookup</button>
			</form>
			
			<h2>Deletion</h2>
			<form data-type="plan" class="delete-form" action="about:blank" method="delete">
				<button type="submit">Delete</button>
			</form>
			
			<h2>Modification</h2>
			<form data-type="plan" class="modify-form" action="about:blank" method="put">
				<div class="template" data-template="modify-field">
					<span class="key"></span>:
					<input class="value" type="text" name="">
				</div>
				
				<button type="submit">Save</button>
			</form>
		</section>
		
		<section class="tab-admin-create-plan">
			<h1>Create plan</h1>
			<form class="create-plan-form" action="/admin/plans" method="post">
				<div>
					<span class="key">Plan name</span>:
					<input class="value" type="text" name="name">
				</div>
				
				<button type="submit">Send</button>
			</form>
		</section>
		
		
		<!-- ADMIN: Presets -->
		
		<section class="tab-admin-list-presets">
			<h1>List presets</h1>
			<form action="/admin/presets" method="get">
				<button type="submit">Send</button>
			</form>
		</section>
		
		<section class="tab-admin-modify-presets">
			<h1>Lookup / modify presets</h1>
			<form data-handler="lookupPreset">
				<div>
					ID:
					<input type="text" name="id">
				</div>
				
				<button type="submit">Lookup</button>
			</form>
			
			<h2>Deletion</h2>
			<form data-type="preset" class="delete-form" action="about:blank" method="delete">
				<button type="submit">Delete</button>
			</form>
			
			<h2>Modification</h2>
			<form data-type="preset" class="modify-form" action="about:blank" method="put">
				<div class="template" data-template="modify-field">
					<span class="key"></span>:
					<input class="value" type="text" name="">
				</div>
				
				<button type="submit">Save</button>
			</form>
		</section>
		
		<section class="tab-admin-create-preset">
			<h1>Create preset</h1>
			<form class="create-preset-form" action="/admin/presets" method="post">
				<div>
					<span class="key">Plan ID</span>:
					<input class="value" type="text" name="planId">
				</div>
				<div>
					<span class="key">Enabled (boolean)</span>:
					<input class="value" type="text" name="isEnabled">
				</div>
				
				<hr>
				
				<div>
					<span class="key">Name</span>:
					<input class="value" type="text" name="name">
				</div>				
				<div>
					<span class="key">Description</span>:
					<input class="value" type="text" name="description">
				</div>				
				<div>
					<span class="key">URL</span>:
					<input class="value" type="text" name="url">
				</div>				
				<div>
					<span class="key">Thumbnail URL</span>:
					<input class="value" type="text" name="thumbnail">
				</div>
				
				<button type="submit">Send</button>
			</form>
		</section>
	</body>
</html>